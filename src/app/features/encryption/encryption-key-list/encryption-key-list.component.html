<div class="page-header">
    <div class="title">密钥管理</div>
    <button nz-button nzType="primary" (click)="showModal()">
      <span nz-icon nzType="plus"></span>新增密钥
    </button>
  </div>

  <nz-card>
    <div class="table-operations">
      <form nz-form [formGroup]="searchForm" class="search-form">
        <nz-form-item>
          <nz-form-label>密钥名称</nz-form-label>
          <nz-form-control>
            <input nz-input formControlName="name" placeholder="请输入密钥名称" />
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label>状态</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="status" nzAllowClear>
              <nz-option nzValue="ACTIVE" nzLabel="激活"></nz-option>
              <nz-option nzValue="INACTIVE" nzLabel="未激活"></nz-option>
              <nz-option nzValue="EXPIRED" nzLabel="已过期"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <button nz-button nzType="primary" (click)="search()">查询</button>
        <button nz-button (click)="reset()">重置</button>
      </form>
    </div>

    <nz-table
      #basicTable
      [nzData]="listOfData"
      [nzLoading]="loading"
      [nzTotal]="total"
      [nzPageSize]="pageSize"
      [nzPageIndex]="pageIndex"
      (nzPageIndexChange)="pageIndexChange($event)"
    >
      <thead>
        <tr>
          <th>名称</th>
          <th>是否默认</th>
          <th>状态</th>
          <th>有效期</th>
          <th>创建人</th>
          <th>创建时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data">
          <td>{{ data.name }}</td>
          <td>
            <nz-tag [nzColor]="data.isDefault ? 'blue' : ''">
              {{ data.isDefault ? '是' : '否' }}
            </nz-tag>
          </td>
          <td>
            <nz-tag [nzColor]="getStatusColor(data.status)">
              {{ getStatusText(data.status) }}
            </nz-tag>
          </td>
          <td>
            {{ data.validFrom | date:'yyyy-MM-dd' }} 至 
            {{ data.validTo | date:'yyyy-MM-dd' }}
          </td>
          <td>{{ data.createdBy?.name }}</td>
          <td>{{ data.createdAt | date:'yyyy-MM-dd HH:mm:ss' }}</td>
          <td>
            <a (click)="showModal(data)">编辑</a>
            <nz-divider nzType="vertical"></nz-divider>
            <a (click)="showDetail(data)">详情</a>
            <nz-divider nzType="vertical"></nz-divider>
            <a nz-popconfirm
               nzPopconfirmTitle="确定删除此密钥?"
               (nzOnConfirm)="deleteKey(data.id)"
               class="danger">删除</a>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>

  <nz-modal
    [(nzVisible)]="isModalVisible"
    [nzTitle]="currentKey ? '编辑密钥' : '新增密钥'"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleOk()"
    [nzOkLoading]="isOkLoading"
    [nzOkDisabled]="!isFormValid"
  >
  <div *nzModalContent>
        <app-encryption-key-form
        #formComponent
        [data]="currentKey"
        (formValid)="onFormValidChange($event)"
        (formValue)="onFormValueChange($event)"
        ></app-encryption-key-form>
    </div>
  </nz-modal>